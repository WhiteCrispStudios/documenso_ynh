#!/bin/bash

set -e
source /usr/share/yunohost/helpers
source ./_common.sh

app=${app:?}

app_domain=${domain}
app_path=${path%/}
if [ -z "$app_path" ]; then app_path="/"; fi
if [[ "$app_path" != /* ]]; then app_path="/$app_path"; fi
app_port=${app_port}

smtp_transport=${smtp_transport:-"smtp-auth"}
smtp_host=${smtp_host:-""}
smtp_port=${smtp_port:-""}
smtp_user=${smtp_user:-""}
smtp_pass=${smtp_pass:-""}
smtp_from_name=${smtp_from_name:-"Documenso"}
smtp_from_address=${smtp_from_address:-"noreply@${app_domain}"}

disable_signup=${disable_signup:-""}

# Check docker
command -v docker >/dev/null 2>&1 || ynh_die "Docker nicht gefunden. Bitte Docker installieren."
command -v openssl >/dev/null 2>&1 || ynh_die "OpenSSL nicht gefunden. Bitte OpenSSL installieren."

install_dir=$(ynh_app_setting_get --app="$app" --key=install_dir)
data_dir=$(ynh_app_setting_get --app="$app" --key=data_dir)

mkdir -p "$data_dir"

# secrets / db creds
DB_USER="${app}"
DB_NAME="${app}"
DB_PASS=$(ynh_string_random --length=32)
NEXTAUTH_SECRET=$(ynh_string_random --length=64)
ENC_KEY=$(ynh_string_random --length=32)
ENC_KEY2=$(ynh_string_random --length=32)
SIGNING_PASSPHRASE=$(ynh_string_random --length=32)

ynh_app_setting_set --app="$app" --key=domain --value="$app_domain"
ynh_app_setting_set --app="$app" --key=path --value="$app_path"
ynh_app_setting_set --app="$app" --key=port --value="$app_port"
ynh_app_setting_set --app="$app" --key=db_user --value="$DB_USER"
ynh_app_setting_set --app="$app" --key=db_name --value="$DB_NAME"
ynh_app_setting_set --app="$app" --key=db_pass --value="$DB_PASS"
ynh_app_setting_set --app="$app" --key=nextauth_secret --value="$NEXTAUTH_SECRET"
ynh_app_setting_set --app="$app" --key=enc_key --value="$ENC_KEY"
ynh_app_setting_set --app="$app" --key=enc_key2 --value="$ENC_KEY2"
ynh_app_setting_set --app="$app" --key=signing_pass --value="$SIGNING_PASSPHRASE"
ynh_app_setting_set --app="$app" --key=smtp_transport --value="${smtp_transport:-}"
ynh_app_setting_set --app="$app" --key=smtp_host --value="${smtp_host:-}"
ynh_app_setting_set --app="$app" --key=smtp_port --value="${smtp_port:-}"
ynh_app_setting_set --app="$app" --key=smtp_user --value="${smtp_user:-}"
ynh_app_setting_set --app="$app" --key=smtp_pass --value="${smtp_pass:-}"
ynh_app_setting_set --app="$app" --key=smtp_from_name --value="${smtp_from_name:-}"
ynh_app_setting_set --app="$app" --key=smtp_from_address --value="${smtp_from_address:-}"
ynh_app_setting_set --app="$app" --key=disable_signup --value="${disable_signup:-}"

app_url="https://${app_domain}${app_path}"

# generate signing cert (self-signed)
if [ ! -f "$data_dir/cert.p12" ]; then
  openssl req -x509 -newkey rsa:2048 -keyout "$data_dir/cert.key" -out "$data_dir/cert.crt" -days 3650 -nodes -subj "/CN=${app_domain}" >/dev/null 2>&1
  openssl pkcs12 -export -out "$data_dir/cert.p12" -inkey "$data_dir/cert.key" -in "$data_dir/cert.crt" -passout pass:"$SIGNING_PASSPHRASE" >/dev/null 2>&1
  rm -f "$data_dir/cert.key" "$data_dir/cert.crt"
fi

cat ../conf/docker-compose.yml \
  | sed "s#__APP__#${app}#g" \
  | sed "s#__APP_URL__#${app_url}#g" \
  | sed "s#__DATA_DIR__#${data_dir}#g" \
  | sed "s#__APP_PORT__#${app_port}#g" \
  | sed "s#__DB_USER__#${DB_USER}#g" \
  | sed "s#__DB_PASS__#${DB_PASS}#g" \
  | sed "s#__DB_NAME__#${DB_NAME}#g" \
  | sed "s#__NEXTAUTH_SECRET__#${NEXTAUTH_SECRET}#g" \
  | sed "s#__ENC_KEY__#${ENC_KEY}#g" \
  | sed "s#__ENC_KEY2__#${ENC_KEY2}#g" \
  | sed "s#__SMTP_TRANSPORT__#${smtp_transport}#g" \
  | sed "s#__SMTP_HOST__#${smtp_host}#g" \
  | sed "s#__SMTP_PORT__#${smtp_port}#g" \
  | sed "s#__SMTP_USER__#${smtp_user}#g" \
  | sed "s#__SMTP_PASS__#${smtp_pass}#g" \
  | sed "s#__SMTP_FROM_NAME__#${smtp_from_name}#g" \
  | sed "s#__SMTP_FROM_ADDRESS__#${smtp_from_address}#g" \
  | sed "s#__DISABLE_SIGNUP__#${disable_signup}#g" \
  | sed "s#__SIGNING_FILE__#/opt/documenso/cert.p12#g" \
  | sed "s#__SIGNING_PASSPHRASE__#${SIGNING_PASSPHRASE}#g" \
  > "$install_dir/docker-compose.yml"

# nginx proxy
ynh_add_nginx_config

# ensure ssowat is disabled for this domain (public app)
ynh_disable_ssowat_for_domain "$app_domain"

cd "$install_dir"
if command -v docker-compose >/dev/null 2>&1; then
  docker-compose up -d
else
  docker compose up -d
fi

# permissions already provisioned by resources.permissions
